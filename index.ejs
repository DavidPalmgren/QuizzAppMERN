const express = require('express');
const path = require('path');
require('dotenv').config();
const { MongoClient } = require('mongodb');
const cors = require('cors');
const app = express()

const URI = process.env.MONGO_URI
const client = new MongoClient(URI)
const database = client.db('main')
const cards = database.collection('cards')

client.connect()
console.log('connected to mongodb')

const PORT = process.env.PORT || 5555

console.log("running");

//'https://studyapp-dapa-98dcdc34bdde.herokuapp.com/'
//'http://localhost:3000'

// platform access remember to change to real address for production
const corsOptions = {
  origin: 'http://localhost:3000',
  methods: 'GET,POST',
};

app.use(cors(corsOptions));

app.use(express.static(path.join(__dirname, 'frontend/my-react-app/build')));
app.use(express.json())

app.listen(PORT, () => console.log('api running'))

app.get('/api/cards', async (req, res) => {
  const allCards = await cards.find().toArray();
  const formattedJson = JSON.stringify(allCards, null, 2); // Indent with 2 spaces
  res.header('Content-Type', 'application/json');
  res.send(formattedJson);
});

app.post('/api/add-card', async (req, res) => {
    const { answer, description, category } = req.body;
  
    try {
      const result = await cards.insertOne({ answer, description, category });
      res.status(201).json({ message: 'Item was added', insertedId: result.insertedId });
    } catch (error) {
      console.error('Error adding item:', error);
      res.status(500).json({ message: 'Error adding item' });
    }
});

app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'frontend/my-react-app/build', 'index.html'));
});
